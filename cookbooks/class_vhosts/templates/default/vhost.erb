# Generated by Chef
<% @vhost['vhosts'].each do |addr,items| -%>
<VirtualHost <%= addr %>>
	ServerName <%= items['ServerName'] %>
	<% if items.has_key?("ServerAlias") -%>
	ServerAlias <%= items['ServerAlias'] %>
	<% end -%>
	<% if items.has_key?("DocumentRoot") -%>
	DocumentRoot <%= items['DocumentRoot'] %>
	<% end -%>
	<% if items.has_key?("SSLCertificate") -%>
	SSLEngine on
	SSLCertificateFile <%= node[:apache][:dir] %>/ssl/crt/<%= @ssl_certs[items['SSLCertificate']] %>.crt
	SSLCertificateKeyFile <%= node[:apache][:dir] %>/ssl/key/<%= @ssl_certs[items['SSLCertificate']] %>.key
	<% if items.has_key?("SSLCertificateChain") -%>
	SSLCertificateChainFile <%= node[:apache][:dir] %>/ssl/crt/<%= @ssl_certs[items['SSLCertificateChain']] %>.crt
	<% end -%>
	<% end -%>
	<% if items.has_key?("CommID") -%>
	RewriteEngine On
	<% end -%>
	<% if items.has_key?("UseServerName") and items['UseServerName'] -%>
	RewriteEngine on
	RewriteCond %{HTTP_HOST} !^<%= items['ServerName'] %> [NC]
	RewriteRule ^(.*)$ <%= (addr.include?(":443") ? "https" : "http") %>://<%= items['ServerName'] %>$1 [L,R=301]
	<% end -%>
	<% if items.has_key?("CommID") -%>
	Alias /crimson/ /data/www/htdocs/crimson/
	RewriteCond %{REQUEST_URI} !^/crimson/
	<% if items.has_key?("SSLCertificate") -%>
	Alias /crimsonAdmin/ /data/www/crimson/
	RewriteCond %{REQUEST_URI} !^/crimsonAdmin/
	<% end -%>
	<% end -%>
	<% items.each do |k,v| -%>
	<% if not ["ServerName","ServerAlias","DocumentRoot","SSLCertificate", "SSLCertificateChain","CommID","UseServerName"].include?(k) -%>
	<% if not v.is_a?(Hash) -%>
	<%= k %> <%= v %>
	<% else -%>
	<% v.each do |sk,sv| -%>
	<% if not sv.is_a?(Hash) -%>
	<%= k %> <%= sk %> <%= sv %>
	<% if items.has_key?("CommID") and ["Alias","Redirect"].include?(k) -%>
	RewriteCond %{REQUEST_URI} !^<%= Regexp.quote(sk) %>
	<% end -%>
	<% else -%>
	<<%= k %> <%= sk %>>
		<% sv.each do |ssk, ssv| -%>
		<%= ssk %> <%= ssk == "AuthName" ? ('"' + ssv + '"') : ssv %>
		<% end -%>
	</<%= k %>>
	<% end -%>
	<% end -%>
	<% end -%>
	<% end -%>
	<% end -%>
	<% if items.has_key?("CommID") -%>
	RewriteRule ^(.+) /index.php?comm_id=<%= items['CommID'] %>&req=$1 [L,QSA]
	<% end -%>
</VirtualHost>
<% end -%>