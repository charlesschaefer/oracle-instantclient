# Generated by Chef
<% @vhost['vhosts'].each do |addr,items| -%>
<VirtualHost <%= addr %>>
	ServerName <%= items['ServerName'] %>
	<% if items.has_key?("ServerAlias") -%>
	ServerAlias <%= items['ServerAlias'] %>
	<% end -%>
	<% if items.has_key?("DocumentRoot") -%>
	DocumentRoot <%= items['DocumentRoot'] %>
	<% end -%>
	DirectoryIndex <%= items.has_key?("DirectoryIndex") ? items['DirectoryIndex'] : "index.php index.html" %>
	LogLevel warn
	LogFormat "%v:%p(%A) %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combinedVhost
	CustomLog /var/log/apache2/access.log combinedVhost
	ErrorLog /var/log/apache2/error.log
	<% if items.has_key?("SSLCertificate") -%>
	SSLEngine on
	SSLHonorCipherOrder On
	SSLCipherSuite RC4-SHA:HIGH:!ADH <%# Prefer non-CBC ciphers (BEAST mitigation) %>
	SSLCertificateFile <%= node[:apache][:dir] %>/ssl/crt/<%= @ssl_certs[items['SSLCertificate']] %>.crt
	SSLCertificateKeyFile <%= node[:apache][:dir] %>/ssl/key/<%= @ssl_certs[items['SSLCertificate']] %>.key
	<% if items.has_key?("SSLCertificateChain") -%>
	SSLCertificateChainFile <%= node[:apache][:dir] %>/ssl/crt/<%= @ssl_certs[items['SSLCertificateChain']] %>.crt
	<% end -%>
	<% end -%>
	<%#
	#
	# Apply the following rules to the remaining items:
	#
	# "key" => "value"                                        to  key value
	# "key" => ["val1","val2"]                                to  val1\nval2
	# "key" => { "subkey" => "subval" }                       to  key subkey subval
	# "key" => { "subkey" => { "subsubkey" => "subsubval" }}  to  <key subkey>\nsubsubkey subsubval\n</key>
	#
	%>
	<% items.each do |k,v| -%>
	<% if not ["ServerName","ServerAlias","DocumentRoot","SSLCertificate", "SSLCertificateChain"].include?(k) -%>
	<% if not v.is_a?(Hash) and not v.is_a?(Array) -%>
	<%= k %> <%= v %>
	<% elsif v.is_a?(Array) -%>
	<% v.each do |sv| -%>
	<%= sv %>
	<% end -%>
	<% else -%>
	<% v.each do |sk,sv| -%>
	<% if not sv.is_a?(Hash) -%>
	<%= k %> <%= sk %> <%= sv %>
	<% else -%>
	<<%= k %> <%= sk %>>
		<% sv.each do |ssk, ssv| -%>
		<%= ssk %> <%= "#{ssk.downcase == "authname" ? "'"+ssv+"'" : ssv}" %>
		<% end -%>
	</<%= k %>>
	<% end -%>
	<% end -%>
	<% end -%>
	<% end -%>
	<% end -%>
</VirtualHost>
<% end -%>
